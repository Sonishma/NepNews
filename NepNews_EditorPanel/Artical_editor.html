<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced Article Editor</title>
  <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f4f4f4;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
    }
    #editor {
  min-height: 500px; /* Increase the height */
  max-height: 700px; /* Optional: Add max height if necessary */
  overflow-y: auto;  /* Enable scrolling if content exceeds */
}

    .image-gallery {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      overflow-x: auto;
    }
    .image-gallery img {
      height: 100px;
      cursor: grab;
      border-radius: 8px;
    }
    #titleInput {
      width: 100%;
      font-size: 1.2rem;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .button-group {
      margin-top: 20px;
    }
    .button-group button {
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Advanced Article Editor with Image Resize</h2>
    
    <input type="text" id="titleInput" placeholder="Article Title" />

    <div id="editor">Loading article content...</div>

    <h4>Drag & Drop Images into the Article</h4>
    <div class="image-gallery" id="imageGallery">
      <img src="https://via.placeholder.com/150/000000" draggable="true" />
      <img src="https://via.placeholder.com/150/111111" draggable="true" />
      <img src="https://via.placeholder.com/150/222222" draggable="true" />
    </div>

    <div class="button-group">
      <button onclick="saveArticle()">Save Article</button>
    </div>
  </div>

  <script>
    let editorInstance;
    let currentArticleId;

    // Get article ID from URL
    function getArticleIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    // Initialize CKEditor
    ClassicEditor
      .create(document.querySelector('#editor'), {
        toolbar: [ 
          'heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList',
          'imageUpload', 'blockQuote', 'insertTable', 'undo', 'redo'
        ],
      })
      .then(editor => {
        editorInstance = editor;
        loadArticle();
      })
      .catch(error => {
        console.error("CKEditor error:", error);
      });

    // Fetch and load article into editor
    function loadArticle() {
      currentArticleId = getArticleIdFromURL();
      if (!currentArticleId) {
        alert("❌ No article ID provided.");
        return;
      }

      fetch(`http://localhost:5000/api/articles/${currentArticleId}`)
        .then(response => {
          if (!response.ok) throw new Error("Article not found.");
          return response.json();
        })
        .then(article => {
          document.getElementById("titleInput").value = article.newsTitle || '';
          editorInstance.setData(article.newsDescription || article.content || '');
        })
        .catch(err => {
          console.error("Failed to load article:", err);
          alert("⚠️ Failed to load article.");
        });
    }

    // Save updated article
    function saveArticle() {
      const updatedTitle = document.getElementById("titleInput").value;
      const updatedContent = editorInstance.getData();

      fetch(`http://localhost:5000/api/articles/${currentArticleId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title: updatedTitle,
          description: updatedContent  // or "content"
        })
      })
      .then(res => res.json())
      .then(data => {
        alert("✅ Article updated successfully.");
      })
      .catch(err => {
        console.error("Update failed:", err);
        alert("❌ Failed to update article.");
      });
    }

    // Enable drag-and-drop images
    document.querySelectorAll(".image-gallery img").forEach(img => {
      img.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/html", `<img src="${img.src}" alt="Dropped Image"/>`);
      });
    });

    document.querySelector("#editor").addEventListener("drop", e => {
      e.preventDefault();
      const html = e.dataTransfer.getData("text/html");
      editorInstance.model.change(writer => {
        const viewFragment = editorInstance.data.processor.toView(html);
        const modelFragment = editorInstance.data.toModel(viewFragment);
        editorInstance.model.insertContent(modelFragment);
      });
    });

    document.querySelector("#editor").addEventListener("dragover", e => e.preventDefault());
  </script>
</body>
</html>
